<!DOCTYPE HTML>
<html>
<head>
</head>
<style>

.center {
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    position: absolute;
    margin: auto;
    height: 500px;
    width: 300px;
    font-family: Metropolis,"Avenir Next","Helvetica Neue",Arial,sans-serif;
}
h2 {
    color: rgb(97, 97, 97);
}
.iconBusy {
	min-width: 32px;
	min-height: 32px;
	background-repeat: no-repeat;
	background-image: url(data:image/gif;base64,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);
}
.iconOK {
    min-width:32px;
    min-height:32px;
    background-repeat: no-repeat;
    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAgCAYAAADnnNMGAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAA7NJREFUSIntll9InWUcx7/f51U555R/wtMfcCCBBcGiyBWOpq8edR4LlM08mCHRsLauii68KOgi2E0XURA0qRUxdHKOMhyj6dy0M1eztTOkbRG1WIPEmp5abvPo9H2/XfhnZ55jc3XRxfa9fH/f9/nw/T38nucB7ui2FNdqtMObi2ChSDBewk3Awblo6NC5/wwJhAMFrpX1GoRmkgUr65LGQHQa59oHg6HBsVuFsLy79g1A75D0SZoGcBTQGQF/EcgFuB5A2fU63/7yuYPvAdBNIfaQncG4Zw9pmiRMAdg5ndCuEy19Uyu9T+0J5vi82gGYt0jkSG6X8mdaohXR+WRfRgo17v2IZJOkM47r1A2HBs6v1oZF8Lul4eqIZVm9pGlC3HsFwMurJimL1IQM2QXgZ80mNkZfiE6uBkjpQIftp8f7NYQiSk1Djf3hFEhxe3Fmtv/enwCsc4GNRxv6vl3L4hXdtc2CWmbcS1uzrLz1BjgO4NfLhRMPxTbE5gDALJmz8/PrCBZCiqwVYHfXtAD4nGTQY/IOXM2cOAspQrAw+5f76pZ8yxDI1AOAS326FkB5JPgiyc/A5X1d55vz5y7/T9WnQgyegDB/dTL+1U0T9NS+BIPdBC0AEPSDQ5UPN/SPX3OmjkGYh1icJgkeADUZ2x6bBgB7n51n76t+PBVQ00rpk+sAfC/HVAw39I8DwEhoJCFoEtD9qZAkbTrw7D3G8R42jjVk9wRLlr5XdAdfodhO0iwmOJuYnQ1EQ1/89k/Jk+ZEv0Pm4eL2Yl9GwumBWYhLqK80svkZQ/OYiA+JRYB0epZO1TfNgxeTFywJl3gJ+gX8mKZdjIHIuMuf/7TANkl/LkCYa9EM8AaA+928i8rjDQM3AAAgy8rZBCIDVCwVQvYCgBG3RRsPnnSoKknxhRJ9SQlGLTMfOBbqm0jXGiNuW2gl9qdALscv7hd0AWRjWU/wyeGG/lNynSpIy1Mv6dSM61Ye2Xokng5gR2o3gGwUdOFK4URvCiS2PTZHV20QjBE67Q7bHw0NjM4JlQImBJ2c91hVI6FDf6QFdNh+GnVCMHTVtjTtCy1fofLu4MckWwWddhynfjg0cL5sb9Uj9MyNR7dEL6UDlIarH7SM1UvyUdd1d0cb+1uT6ymnsPITryLuuZs0TZYxo+XdNTunE9x1Ysvh1Y968k2CuRK64J/ZsdL3/1xayQqEAwWuyXwd5PNEmusXGoO017hz7/+b6zdFyw8Jlz4aTd/KQ+KOblP9DQRjt63kvo4TAAAAAElFTkSuQmCC);
}
.center {
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    position: absolute;
    margin: auto;
    height: 500px;
    width: 800px;
}

.myButton {
    background-color: #4CAF50; /* Green */
    border: none;
    color: white;
    padding: 12px 40px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    border-radius: 6px;
    box-shadow: 0 5px #999;
}

.myButton:hover {background-color: #3e8e41}

.myButton:active {
  background-color: #3e8e41;
  box-shadow: 0 1px #666;
  transform: translateY(4px);
}
</style>
<body>
    <div class="center">
        <h2>Connect Cluster to Compliance Dashboard for K8s</h2>
        <br/>
        <br/>
        <div>
            Run the following command with your k8s: 
        </div>
        <table>
            <tr>
                <td width="100%"><p id="data-container" style="width: 800px; background-color: aliceblue;"></p></td>
                <td nowrap><button id="copy-button" onclick="copyToClipboard()">Copy to Clipboard</button></td>
            </tr>
        </table>
        <br/>
        <br/>
        <div>
            <table>
                <tr>
                    <td>
                        <div id="agent-status-icon" class="iconBusy" alt="loading...">
                    </td>
                    <td width="100%" cellpadding="10px">
                        <p id="agent-status-message" >agent_msg</p>
                    </td>
                </tr>
            </table>
        </div>
        <br/>
        <br/>
        <div>
            <button id="go" disabled onclick="openDashboard()">Open Dashboard for the above agent</button>
        </div>
        <br/>
        <br/>
        <br/>
        <div>
            <button id="go" onclick="openDashboardForAll()">Open Dashboard for all managed clusters in the org</button>
        </div>
    </div>
</body>
<script type="text/javascript">

    let _agentId = localStorage.getItem("agentId")
	
    function openDashboard(event) {
        let target = "{{.grafanaURL}}?orgId={{.grafanaOrgId}}&var-Filters=a%7C%3D%7C" + _agentId
        location.href = target
    }

    function openDashboardForAll(event) {
        let target = "{{.grafanaURL}}?orgId={{.grafanaOrgId}}"
        window.open(target, '_blank').focus();
    }
    
    function callApi(url, onData, responseType) {
        var xhr = new XMLHttpRequest()
        xhr.open("GET", url)
        xhr.responseType = responseType || 'json'
        // Define what should happen when the request is successful
        xhr.onload = () => onData(xhr.response)

        // Define what should happen when there is an error
        xhr.onerror = () => console.error("Error: The request could not be completed.")
        xhr.send();
    }

    function loadBootstrapCmd() {
        callApi("/collie/api/v1/onboarding/bootstrap", data => {
            _agentId = data.aid
            document.getElementById("data-container").innerHTML = data.cmd
            document.getElementById("agent-status-message").innerHTML = `Waiting for agent ${_agentId}`
        })
    }

    function copyToClipboard() {
        var paragraph = document.getElementById("data-container");
        // Select the text in the paragraph
        var range = document.createRange();
        range.selectNodeContents(paragraph);
        var selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        // Copy the selected text to the clipboard
        document.execCommand("copy");

        // Deselect the text
        selection.removeAllRanges();
    }

    let _agentStatusPoller
    function startAgentStatusPolling() {
        function pollAgentStatus() {
            callApi("/collie/api/v1/onboarding/status?aid=" + _agentId, data => {
                if ('connected' === data.agent) {
                    onAgentConnected()
                }
            })
        }
        function onAgentConnected() {
            clearInterval(_agentStatusPoller)
            document.getElementById("agent-status-icon").className = "iconOK"
            document.getElementById("agent-status-message").innerHTML = "Agent connected."
            document.getElementById("go").disabled = false
        }
        _agentStatusPoller = setInterval(pollAgentStatus, 5000)
    }
    

    function onDocLoaded() {
        loadBootstrapCmd()
        startAgentStatusPolling()
    }
    document.addEventListener("DOMContentLoaded", onDocLoaded)

</script>
</html>
